UPDATE `stretchy_report` SET report_sql = "select a.display_name, a.branch_name, a.last_transaction_date, ifnull(a.mobile_no, 'NA') as mobileNo, a.savings_Id, a.client_Id as id,a.product_Short_Name from (select cl.display_name,sa.product_id,cl.id as client_Id , cl.default_savings_product,sa.id as savings_Id,mo.name as branch_name,mp.short_name as product_Short_Name, cl.mobile_no as mobile_no,MAX(transaction_date)as last_transaction_date from m_client cl inner join m_office mo on mo.id=cl.office_id inner join officedetails od on od.office_id=mo.id inner join m_savings_account sa on sa.client_id=cl.id inner join m_savings_product mp on mp.id=sa.product_id left join m_savings_account_transaction msa on msa.savings_account_id=sa.id where  sa.id=cl.default_savings_account and (msa.transaction_type_enum=1 or msa.transaction_type_enum is null) and cl.status_enum = 300 and cl.sub_status =27 and sa.status_enum=300 and od.sms_enabled=true and case when ${officeId} =0 then 1=1 else mo.id = ${officeId} end group by sa.account_no)a\nwhere \nif(a.last_transaction_date is null, TIMESTAMPDIFF (MONTH,curDate(),'${startDate}')=0, TIMESTAMPDIFF (MONTH,a.last_transaction_date,'${startDate}')=4)' WHERE `report_name` = 'DormancyWarning - Clients";
UPDATE `stretchy_report` SET report_sql = "select a.client_name, a.branch_name, a.overdue_amount, a.mobile_no as mobileNo, a.loan_id, a.client_id as id,a.productshort_Name from (select c.firstname as client_name,o.name as branch_name, c.mobile_no as mobile_no,date_format(lrc.duedate,'%M ')as month, c.id as client_id,l.id as loan_id,mp.short_name as productshort_Name,lrc.duedate as duedate, max(mlt.transaction_date) as last_txn_date,ifnull(mlaa.total_overdue_derived,0) as overdue_amount,if (((lrc.principal_amount+lrc.interest_amount)>(ifnull(lrc.principal_completed_derived,0)+ifnull(lrc.interest_completed_derived,0))),(datediff('${startDate}',date_add(date_add(makedate(extract(year from lrc.duedate),extract(day from lrc.duedate)),interval extract(month from lrc.duedate) +3 month),interval 5 day))),null) as days, ifnull(sum(mlaa.total_overdue_derived),0) overdueAmount from m_client c inner join m_loan l on c.id=l.client_id inner join m_loan_transaction mlt on mlt.loan_id = l.id and mlt.is_reversed = 0 inner join m_product_loan mp on mp.id=l.product_id inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id inner join m_office o on c.office_id=o.id inner join officedetails od on od.office_id=o.id and od.sms_enabled=true join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id join event_sourcing_details esd on esd.report_name = 'DefaultWarning - Clients' and esd.entity_mobile_no != c.mobile_no where datediff('${startDate}',lrc.duedate)>=1 and  lrc.completed_derived=0 and l.loan_status_id=300 and case when ${officeId} =0 then 1=1 else o.id = ${officeId} end and case when ( select count(esd.mobile_no) from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 200 OR esd.status_enum =300) and rp.report_name = 'DefaultWarning - Clients' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY}) >0 then c.mobile_no not in (select esd.mobile_no from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 200 OR esd.status_enum =300) and rp.report_name = 'DefaultWarning - Clients' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} group by esd.mobile_no ) else 1 end group by lrc.loan_id UNION select c.firstname as client_name,o.name as branch_name, c.mobile_no as mobile_no, date_format(lrc.duedate,'%M ')as month, c.id as client_id,l.id as loan_id, mp.short_name as productshort_Name, lrc.duedate as duedate, 'No_Date' as last_txn_date, ifnull(mlaa.total_overdue_derived,0) as overdue_amount, if (((lrc.principal_amount+lrc.interest_amount)>(ifnull(lrc.principal_completed_derived,0) +ifnull(lrc.interest_completed_derived,0))),(datediff('${startDate}',date_add(date_add(makedate(extract(year from lrc.duedate), extract(day from lrc.duedate)),interval extract(month from lrc.duedate) +3 month), interval 5 day))),null) as days, ifnull(sum(mlaa.total_overdue_derived),0) overdueAmount from m_client c inner join m_loan l on c.id=l.client_id inner join m_loan_transaction mlt on mlt.loan_id = l.id and mlt.is_reversed = 0 inner join m_product_loan mp on mp.id=l.product_id inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id inner join m_office o on c.office_id=o.id inner join officedetails od on od.office_id=o.id and od.sms_enabled=true join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id where l.loan_status_id=300 and case when ${officeId} =0 then 1=1 else o.id = ${officeId} end and case when (select count(esd.mobile_no) from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 400) and rp.report_name = 'DefaultWarning - Clients' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} ) >0 then c.mobile_no in ( select esd.mobile_no from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 400) and rp.report_name = 'DefaultWarning - Clients' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} group by esd.mobile_no ) else 0 end group by lrc.loan_id ) a where a.overdue_amount > 0 and datediff('${startDate}',a.last_txn_date) >= 150 OR a.last_txn_date = 'No_Date' WHERE `report_name` = 'DefaultWarning - Clients";
UPDATE `stretchy_report` SET report_sql = "select a.client_name, a.Guarantor_name, a.Guarantor_Branch, a.client_mobile_no, a.loan_id, a.client_id as id, productshort_Name, a.Guarantor_mobile_no as mobileNo, a.comitted_Shares from (select cl.firstname as client_name ,ifnull(go.firstname,concat(gu.firstname,gu.lastname)) as Guarantor_name,ifnull(o.name,'NA ') as Guarantor_Branch,ifnull(go.mobile_no,gu.mobile_number) as Guarantor_mobile_no,co.name as Client_Branch,ifnull(cl.mobile_no,'NA ') as client_mobile_no,cl.id as client_id,l.id as loan_id,mp.short_name as productshort_Name,ifnull(gfd.amount_remaining_derived,0) as comitted_Shares, max(mlt.transaction_date) as last_txn_date, ifnull(sum(mlaa.total_overdue_derived),0) as overdueAmount from m_loan l inner join m_loan_transaction mlt on mlt.loan_id = l.id and mlt.is_reversed = 0 inner join m_product_loan mp on mp.id=l.product_id inner join m_client cl on cl.id=l.client_id inner join m_guarantor gu on gu.loan_id=l.id left join m_guarantor_funding_details gfd on gfd.guarantor_id=gu.id left join m_client go on go.id=gu.entity_id join m_savings_account msa on go.id = msa.client_id and msa.client_id != l.client_id left join m_office o on o.id=go.office_id left join m_office co on co.id=cl.office_id inner join officedetails od on od.office_id=co.id join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id join event_sourcing_details esd on esd.report_name = 'DefaultWarning -  guarantors' and esd.entity_mobile_no != go.mobile_no and esd.entity_mobile_no != cl.mobile_no where l.loan_status_id=300 and   gu.is_active=1 and gfd.status_enum = 100 and od.sms_enabled=true and case when ${officeId} =0 then 1=1 else o.id = ${officeId} end group by l.id, gu.id UNION select cl.firstname as client_name ,ifnull(go.firstname,concat(gu.firstname,gu.lastname)) as Guarantor_name ,ifnull(o.name,'NA ') as Guarantor_Branch,ifnull(go.mobile_no,gu.mobile_number) as Guarantor_mobile_no, co.name as Client_Branch ,ifnull(cl.mobile_no,'NA ') as client_mobile_no ,cl.id as client_id,l.id as loan_id,mp.short_name as productshort_Name, ifnull(gfd.amount_remaining_derived,0) as comitted_Shares, 'No_Date' as last_txn_date, ifnull(sum(mlaa.total_overdue_derived),0) as overdueAmount from m_loan l inner join m_loan_transaction mlt on mlt.loan_id = l.id and mlt.is_reversed = 0 inner join m_product_loan mp on mp.id=l.product_id inner join m_client cl on cl.id=l.client_id inner join m_guarantor gu on gu.loan_id=l.id left join m_guarantor_funding_details gfd on gfd.guarantor_id=gu.id left join m_client go on go.id=gu.entity_id join m_savings_account msa on go.id = msa.client_id and msa.client_id != l.client_id left join m_office o on o.id=go.office_id left join m_office co on co.id=cl.office_id inner join officedetails od on od.office_id=co.id join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id where l.loan_status_id=300 and   gu.is_active=1 and gfd.status_enum = 100 and od.sms_enabled=true and case when ${officeId} =0 then 1=1 else o.id = ${officeId} end and  case when (select count(esd.mobile_no) from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 400) and rp.report_name = 'DefaultWarning -  guarantors' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} ) >0 then ifnull(go.mobile_no,gu.mobile_number) in ( select esd.mobile_no from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 400) and rp.report_name = 'DefaultWarning -  guarantors' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} group by esd.mobile_no) else 0 end group by l.id, gu.id )a where a.overdueAmount > 0\n	and\n	datediff('${startDate}',a.last_txn_date) >= 150 or a.last_txn_date = 'No_Date' WHERE `report_name` = 'DefaultWarning -  guarantors";
UPDATE `stretchy_report` SET report_sql = "select a .client_name, a.Guarantor_name, a.Guarantor_Branch,a.client_mobile_no, a.loan_id, a.client_id as id,a.productshort_Name,a.Guarantor_mobile_no as mobileNo from (select date_format(lrc.duedate,'%M-%Y')as month_year,max(mlt.transaction_date) as last_txn_date,cl.firstname as client_name ,ifnull(go.firstname,concat(gu.firstname,'',gu.lastname)) as Guarantor_name ,ifnull(o.name,'NA ') as Guarantor_Branch\n ,ifnull(go.mobile_no,gu.mobile_number) as Guarantor_mobile_no\n ,co.name as Client_Branch ,ifnull(cl.mobile_no,'NA ') as client_mobile_no ,min(lrc.duedate)as mindate\n ,lrc.duedate as duedate,\n cl.id as client_id,l.id as loan_id,mp.short_name as productshort_Name, if (((lrc.principal_amount+lrc.interest_amount)>(ifnull(lrc.principal_completed_derived,0) +ifnull(lrc.interest_completed_derived,0))), (datediff('${startDate}',date_add(date_add(makedate(extract(year from lrc.duedate),extract(day from lrc.duedate)) ,interval extract(month from lrc.duedate) +2 month),interval 5 day))),null) as days,\n  ifnull(sum(mlaa.total_overdue_derived),0) as overdueAmoun from m_loan l inner join m_loan_transaction mlt on l.id = mlt.loan_id and mlt.is_reversed = 0 inner join m_product_loan mp on mp.id=l.product_id\n inner join m_client cl on cl.id=l.client_id \n inner join m_guarantor gu on gu.loan_id=l.id\n inner join m_guarantor_funding_details gf on gu.id = gf.guarantor_id\n inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id\n left join m_client go on go.id=gu.entity_id\n left join m_office o on o.id=go.office_id\n left join m_office co on co.id=cl.office_id\n inner join officedetails od on od.office_id=co.id join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id where lrc.completed_derived=0 and  gf.status_enum = 100\n and l.loan_status_id=300 and od.sms_enabled=true\n and case when ${officeId} =0 then 1=1 else o.id = ${officeId} end and case when (select count(esd.mobile_no) from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 200 OR esd.status_enum =300) and rp.report_name = 'Loan Fourth Overdue Repayment Reminder' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY}) >0 then go.mobile_no not in ( select esd.mobile_no from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 200 OR esd.status_enum =300) and rp.report_name = 'Loan Fourth Overdue Repayment Reminder' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} group by esd.mobile_no ) else 1 end group by gu.id UNION select date_format(lrc.duedate,'%M-%Y')as month_year, 'No_Date' as last_txn_date,\n  cl.firstname as client_name\n ,ifnull(go.firstname,concat(gu.firstname,'',gu.lastname)) as Guarantor_name\n ,ifnull(o.name,'NA ') as Guarantor_Branch ,ifnull(go.mobile_no,gu.mobile_number) as Guarantor_mobile_no ,co.name as Client_Branch ,ifnull(cl.mobile_no,'NA ') as client_mobile_no ,min(lrc.duedate)as mindate ,lrc.duedate as duedate, cl.id as client_id,l.id as loan_id,mp.short_name as productshort_Name, if (((lrc.principal_amount+lrc.interest_amount)>(ifnull(lrc.principal_completed_derived,0)\n  +ifnull(lrc.interest_completed_derived,0))), (datediff('${startDate}',date_add(date_add(makedate(extract(year from lrc.duedate),extract(day from lrc.duedate)) ,interval extract(month from lrc.duedate) +2 month),interval 5 day))),null) as days,\n  \n  ifnull(sum(mlaa.total_overdue_derived),0) as overdueAmount from m_loan l\n inner join m_loan_transaction mlt on l.id = mlt.loan_id and mlt.is_reversed = 0\n inner join m_product_loan mp on mp.id=l.product_id\n inner join m_client cl on cl.id=l.client_id \n inner join m_guarantor gu on gu.loan_id=l.id\n inner join m_guarantor_funding_details gf on gu.id = gf.guarantor_id\n inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id left join m_client go on go.id=gu.entity_id left join m_office o on o.id=go.office_id left join m_office co on co.id=cl.office_id\n inner join officedetails od on od.office_id=co.id  and od.sms_enabled=true\n join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id\n where gf.status_enum = 100 and l.loan_status_id=300 and case when ${officeId} =0 then 1=1 else o.id = ${officeId} end and case when (select count(esd.mobile_no) from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 400) and rp.report_name = 'Loan Fourth Overdue Repayment Reminder' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} ) >0 then go.mobile_no in ( select esd.mobile_no from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 400) and rp.report_name = 'Loan Fourth Overdue Repayment Reminder' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} group by esd.mobile_no ) else 0 end group by gu.id)a where a.overdueAmount > 0 and datediff('${startDate}',a.last_txn_date) = 150 or a.last_txn_date = 'No_Date' WHERE `report_name` = 'Loan Fourth Overdue Repayment Reminder";
UPDATE `stretchy_report` SET report_sql = "select a.client_name, a.Guarantor_name, a.Guarantor_Branch, a.client_mobile_no, a.loan_id, a.client_id as id,productshort_Name, a.Guarantor_mobile_no as mobileNo from (select max(mlt.transaction_date) as last_txn_date,cl.firstname as client_name ,ifnull(go.firstname,concat(gu.firstname,'',gu.lastname)) as Guarantor_name\n,ifnull(o.name,'NA ') as Guarantor_Branch\n,ifnull(go.mobile_no,gu.mobile_number) as Guarantor_mobile_no\n,co.name as Client_Branch\n,ifnull(cl.mobile_no,'NA') as client_mobile_no,cl.id as client_id,l.id as loan_id,mp.short_name as productshort_Name,ifnull(sum(mlaa.total_overdue_derived),0) overdueAmount from m_loan l inner join m_loan_transaction mlt on l.id = mlt.loan_id and mlt.is_reversed = 0\ninner join m_product_loan mp on mp.id=l.product_id inner join m_client cl on cl.id=l.client_id inner join m_guarantor gu on gu.loan_id=l.id inner join m_guarantor_funding_details gf on gu.id = gf.guarantor_id\nleft join m_client go on go.id=gu.entity_id\nleft join m_office o on o.id=go.office_id\nleft join m_office co on co.id=cl.office_id\ninner join officedetails od on od.office_id=co.id left join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id\nwhere l.loan_status_id=300\nand od.sms_enabled=true\nand gf.status_enum = 100\nand case when ${officeId} =0 then 1=1 else o.id = ${officeId} end and case when ( select count(esd.mobile_no) from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 200 OR esd.status_enum =300) and rp.report_name = 'Loan Third Overdue Repayment Reminder' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} ) >0 then go.mobile_no not in (select esd.mobile_no from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 200 OR esd.status_enum =300) and rp.report_name = 'Loan Third Overdue Repayment Reminder' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} group by esd.mobile_no) else 1 end group by gu.id\n\n\n  UNION select 'No_Date' as last_txn_date\n,cl.firstname as client_name\n,ifnull(go.firstname,concat(gu.firstname,'',gu.lastname)) as Guarantor_name\n,ifnull(o.name,'NA ') as Guarantor_Branch\n,ifnull(go.mobile_no,gu.mobile_number) as Guarantor_mobile_no,co.name as Client_Branch\n,ifnull(cl.mobile_no,'NA') as client_mobile_no\n,cl.id as client_id,l.id as loan_id,mp.short_name as productshort_Name, \nifnull(sum(mlaa.total_overdue_derived),0) overdueAmount from m_loan l\ninner join m_loan_transaction mlt on l.id = mlt.loan_id and mlt.is_reversed = 0\ninner join m_product_loan mp on mp.id=l.product_id inner join m_client cl on cl.id=l.client_id \ninner join m_guarantor gu on gu.loan_id=l.id and gu.is_active = true\ninner join m_guarantor_funding_details gf on gu.id = gf.guarantor_id and gf.status_enum = 100\nleft join m_client go on go.id=gu.entity_id\nleft join m_office o on o.id=go.office_id left join m_office co on co.id=cl.office_id inner join officedetails od on od.office_id=co.id and od.sms_enabled=true\nleft join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id\nwhere case when ${officeId} =0 then 1=1 else  o.id = ${officeId} end and case when (select count(esd.mobile_no) from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 400) and rp.report_name = 'Loan Third Overdue Repayment Reminder' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} ) >0 then go.mobile_no in ( select esd.mobile_no from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 400) and rp.report_name = 'Loan Third Overdue Repayment Reminder' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} group by esd.mobile_no ) else 0 end group by gu.id  )a where  a.overdueAmount > 0 and  datediff('${startDate}',a.last_txn_date) = 120 or a.last_txn_date = 'No_Date' WHERE `report_name` = 'Loan Third Overdue Repayment Reminder";
UPDATE `stretchy_report` SET report_sql = "select a.client_name, a.branch_name, a.overdue_amount, a.mobile_no as mobileNo, a.loan_id, a.client_id as id,a.productshort_Name, a.month from (-- normal case: where the last loan repayment was before 60 days then should recived the -- second reminder\n  select c.firstname as client_name,o.name as branch_name, c.mobile_no as mobile_no,date_format(max(mlt.transaction_date),'%M') as month,date_format(lrc.duedate,'%M-%Y')as month_year,max(mlt.transaction_date) as last_txn_date,c.id as client_id,l.id as loan_id,mp.short_name as productshort_Name,lrc.duedate as duedate,round(ifnull(mlaa.total_overdue_derived,0),0) as overdue_amount, if (((lrc.principal_amount+lrc.interest_amount)>(ifnull(lrc.principal_completed_derived,0)+ ifnull(lrc.interest_completed_derived,0))), (datediff('${startDate}', date_add(date_add(makedate(extract(year from lrc.duedate),extract(day from lrc.duedate)), interval extract(month from lrc.duedate) month),interval 5 day))),null) as days from m_client c  inner join m_loan l on c.id=l.client_id and l.loan_status_id=300 inner join m_loan_transaction mlt on l.id = mlt.loan_id and mlt.is_reversed = 0 inner join m_product_loan mp on mp.id=l.product_id inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id inner join m_office o on c.office_id=o.id inner join officedetails od on od.office_id=o.id and od .sms_enabled=true left join m_loan_arrears_aging mlaa on l.id = mlaa.loan_id where case when ${officeId} =0 then 1=1 else o.id = ${officeId} end and case when (select count(esd.mobile_no) from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 200 OR esd.status_enum =300) and rp.report_name = 'Loan Second Overdue Repayment Reminder' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY}) >0 then c.mobile_no not in ( select esd.mobile_no from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 200 OR esd.status_enum =300) and rp.report_name = 'Loan Second Overdue Repayment Reminder' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} group by esd.mobile_no ) else 1 end group by lrc.loan_id UNION select c.firstname as client_name,o.name as branch_name, c.mobile_no as mobile_no, date_format(max(mlt.transaction_date),'%M-%Y') as month, date_format(lrc.duedate,'%M')as month_year, 'No_Date' as last_txn_date, c.id as client_id,l.id as loan_id, mp.short_name as productshort_Name, lrc.duedate as duedate, round(ifnull(mlaa.total_overdue_derived,0),0) as overdue_amount, if (((lrc.principal_amount+lrc.interest_amount)>(ifnull(lrc.principal_completed_derived,0)+ ifnull(lrc.interest_completed_derived,0))), (datediff('${startDate}', date_add(date_add(makedate(extract(year from lrc.duedate),extract(day from lrc.duedate)), interval extract(month from lrc.duedate) month),interval 5 day))),null) as days from m_client c inner join m_loan l on c.id=l.client_id and l.loan_status_id=300 inner join m_loan_transaction mlt on l.id = mlt.loan_id and mlt.is_reversed = 0 inner join m_product_loan mp on mp.id=l.product_id inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id inner join m_office o on c.office_id=o.id inner join officedetails od on od.office_id=o.id and od .sms_enabled=true left join m_loan_arrears_aging mlaa on l.id = mlaa.loan_id where case when ${officeId} =0 then 1=1 else o.id = ${officeId} end and  case when (select count(esd.mobile_no) from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 400) and rp.report_name = 'Loan Second Overdue Repayment Reminder' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} ) >0 then c.mobile_no in (select esd.mobile_no from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 400) and rp.report_name = 'Loan Second Overdue Repayment Reminder' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} group by esd.mobile_no ) else 0 end group by lrc.loan_id )a where  a.overdue_amount > 0  and  datediff('${startDate}',last_txn_date) = 90 or last_txn_date = 'No_Date' group by a.mobile_no' WHERE `report_name` = 'Loan Second Overdue Repayment Reminder";
UPDATE `stretchy_report` SET report_sql = "select a.client_name, a.branch_name, a.overdue_amount, a.mobile_no as mobileNo, a.loan_id, a.client_id as id, a.productshort_Name, a.month from( select c.firstname as client_name, o.name as branch_name, c.mobile_no as mobile_no,date_format(max(mlt.transaction_date),'%M') as month,max(mlt.transaction_date) as last_txn_date,c.id as client_id,l.id as loan_id,mp.short_name as productshort_Name,round(ifnull(mlaa.total_overdue_derived,0),0) as overdue_amount,if (((lrc.principal_amount+lrc.interest_amount)>(ifnull(lrc.principal_completed_derived,0)+ifnull(lrc.interest_completed_derived,0))),(datediff('${startDate}',lrc.duedate)),null) as days from m_client c inner join m_loan l on c.id=l.client_id and l.loan_status_id=300 inner join m_loan_transaction mlt on l.id = mlt.loan_id and mlt.is_reversed = 0 inner join m_product_loan mp on mp.id=l.product_id inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id inner join m_office o on c.office_id=o.id inner join officedetails od on od.office_id=o.id and od.sms_enabled=true left join m_loan_arrears_aging mlaa on l.id = mlaa.loan_id where case when ${officeId} =0 then 1=1 else o.id = ${officeId} end and case when (select count(esd.mobile_no) from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 200 OR esd.status_enum =300) and rp.report_name = 'Loan First Overdue Repayment Reminder' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} ) >0 then c.mobile_no not in (select esd.mobile_no from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 200 OR esd.status_enum =300) and rp.report_name = 'Loan First Overdue Repayment Reminder' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} group by esd.mobile_no) else 1 end group by lrc.loan_id UNION select c.firstname as client_name, o.name as branch_name, c.mobile_no as mobile_no, date_format(max(mlt.transaction_date),'%M') as month, 'No_Date' as last_txn_date, c.id as client_id,l.id as loan_id, mp.short_name as productshort_Name, round(ifnull(mlaa.total_overdue_derived,0),0) as overdue_amount, if (((lrc.principal_amount+lrc.interest_amount)>(ifnull(lrc.principal_completed_derived,0) +ifnull(lrc.interest_completed_derived,0))), (datediff('${startDate}',lrc.duedate)),null) as days from m_client c inner join m_loan l on c.id=l.client_id and l.loan_status_id=300 inner join m_loan_transaction mlt on l.id = mlt.loan_id and mlt.is_reversed = 0 inner join m_product_loan mp on mp.id=l.product_id inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id inner join m_office o on c.office_id=o.id inner join officedetails od on od.office_id=o.id  and od.sms_enabled=true left join m_loan_arrears_aging mlaa on l.id = mlaa.loan_id where case when ${officeId} =0 then 1=1 else o.id = ${officeId} end and case when (select count(esd.mobile_no) from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 400) and rp.report_name = 'Loan First Overdue Repayment Reminder' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} ) > 0 then c.mobile_no in ( select esd.mobile_no from sms_messages_outbound esd\n JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 400) and rp.report_name = 'Loan First Overdue Repayment Reminder' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} group by esd.mobile_no ) else 0 end group by lrc.loan_id)a\n\nwhere  a.overdue_amount > 0\n AND datediff('${startDate}',a.last_txn_date) = 30 or a.last_txn_date = 'No_Date' WHERE `report_name` = 'Loan First Overdue Repayment Reminder";
UPDATE `stretchy_report` SET report_sql = "select a.client_name, a.branch_name, a.due_date, a.mobile_no as mobileNo, a.loan_id , a.client_id as id, a.productshort_name from (select c.display_name as client_name,o.name as branch_name, lrc.duedate as due_date,c.mobile_no as mobile_no,l.id as loan_id,c.id as client_id,mp.short_name as productShort_name,if (((ifnull(lrc.principal_amount,0)+ ifnull(lrc.interest_amount,0))> (ifnull(lrc.principal_completed_derived,0)+ifnull(lrc .interest_completed_derived,0))),(datediff(lrc.duedate,'${startDate}')),null) as days,max(mlt.transaction_date) as last_txn_date,ifnull(mlaa.total_overdue_derived,0) as arrears from m_client c inner join m_loan l on c.id=l.client_id inner join m_product_loan mp on mp.id=l.product_id inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id join m_loan_transaction mlt on mlt.loan_id = l.id and mlt.is_reversed = 0 inner join m_office o on c.office_id=o.id inner join officedetails od on od.office_id=o.id left join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id where  lrc.completed_derived=0 and l.loan_status_id=300 and od.sms_enabled=true and case when ${officeId}=0 then 1=1 else o.id = ${officeId} end and case when (select count(esd.mobile_no) from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 200 OR esd.status_enum =300) and rp.report_name = 'Loan Repayment Reminders' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY}) >0 then c.mobile_no not in (select esd.mobile_no from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 200 OR esd.status_enum =300) and rp.report_name = 'Loan Repayment Reminders' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} group by esd.mobile_no) else 1 end group by l.id UNION select c.display_name as client_name,o.name as branch_name, lrc.duedate as due_date,c.mobile_no as mobile_no,\n l.id as loan_id,c.id as client_id,\n mp.short_name as productShort_name,\n if (((ifnull(lrc.principal_amount,0)+ ifnull(lrc.interest_amount,0))> (ifnull(lrc.principal_completed_derived,0)+ifnull(lrc .interest_completed_derived,0))), (datediff(lrc.duedate,'${startDate}')),null) as days, max(mlt.transaction_date) as last_txn_date, ifnull(mlaa.total_overdue_derived,0) as arrears from m_client c inner join m_loan l on c.id=l.client_id inner join m_product_loan mp on mp.id=l.product_id inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id join m_loan_transaction mlt on mlt.loan_id = l.id and mlt.is_reversed = 0 inner join m_office o on c.office_id=o.id inner join officedetails od on od.office_id=o.id left join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id where  lrc.completed_derived=0 and l.loan_status_id=300 and od.sms_enabled=true and case when ${officeId}=0 then 1=1 else o.id = ${officeId} end and case when (select count(esd.mobile_no) from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 400) and rp.report_name = 'Loan Repayment Reminders' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} ) >0 then c.mobile_no in ( select esd.mobile_no from sms_messages_outbound esd JOIN sms_campaign cam on cam.id = esd.campaign_id JOIN stretchy_report rp on rp.id = cam.report_id where (esd.status_enum = 400) and rp.report_name = 'Loan Repayment Reminders' and DATEDIFF('${startDate}',esd.submittedon_date) between ${fromX} and ${toY} group by esd.mobile_no) else 0 end group by l.id )a\n\n where\n case when extract(year_month from (a.last_txn_date)) = extract(year_month from ('${startDate}')) then a.arrears > 0 else 1 end and a.days between ${fromX} and ${toY} group by a.loan_id ";
