INSERT IGNORE INTO `stretchy_parameter` (`parameter_name`, `parameter_variable`, `parameter_label`, `parameter_displayType`, `parameter_FormatType`, `parameter_default`, `special`, `selectOne`, `selectAll`, `parameter_sql`, `parent_id`) VALUES ('DefaultOffice', 'officeId', 'Office', 'none', 'number', '0', NULL, NULL, 'Y', 'select id, \r\nconcat(substring("........................................", 1, \r\n   \n\n((LENGTH(`hierarchy`) - LENGTH(REPLACE(`hierarchy`, \'.\', \'\')) - 1) * 4)), \r\n   `name`) as tc\r\nfrom m_office\r\nwhere hierarchy like concat\n\n(\'${currentUserHierarchy}\', \'%\')\r\norder by hierarchy', NULL);

INSERT IGNORE INTO `stretchy_report_parameter` (`report_id`, `parameter_id`, `report_parameter_name`) VALUES ((select id from stretchy_report where report_name='Loan Repayment Reminders'), (select id from stretchy_parameter where parameter_name = 'DefaultOffice'), 'officeId'), ((select id from stretchy_report where report_name='Loan Repayment Reminders'), (select id from stretchy_parameter where parameter_name = 'fromXSelect'), 'fromX'), ((select id from stretchy_report where report_name='Loan Repayment Reminders'), (select id from stretchy_parameter where parameter_name = 'toYSelect'), 'toY');
INSERT IGNORE INTO `stretchy_report_parameter` (`report_id`, `parameter_id`, `report_parameter_name`) VALUES ((select id from stretchy_report where report_name='Loan First Overdue Repayment Reminder'), (select id from stretchy_parameter where parameter_name = 'DefaultOffice'), 'officeId'), ((select id from stretchy_report where report_name='Loan First Overdue Repayment Reminder'), (select id from stretchy_parameter where parameter_name = 'fromXSelect'), 'fromX'), ((select id from stretchy_report where report_name='Loan First Overdue Repayment Reminder'), (select id from stretchy_parameter where parameter_name = 'toYSelect'), 'toY');
INSERT IGNORE INTO `stretchy_report_parameter` (`report_id`, `parameter_id`, `report_parameter_name`) VALUES ((select id from stretchy_report where report_name='Loan Second Overdue Repayment Reminder'), (select id from stretchy_parameter where parameter_name = 'DefaultOffice'), 'officeId'), ((select id from stretchy_report where report_name='Loan Second Overdue Repayment Reminder'), (select id from stretchy_parameter where parameter_name = 'fromXSelect'), 'fromX'), ((select id from stretchy_report where report_name='Loan Second Overdue Repayment Reminder'), (select id from stretchy_parameter where parameter_name = 'toYSelect'), 'toY');
INSERT IGNORE INTO `stretchy_report_parameter` (`report_id`, `parameter_id`, `report_parameter_name`) VALUES ((select id from stretchy_report where report_name='Loan Third Overdue Repayment Reminder'), (select id from stretchy_parameter where parameter_name = 'DefaultOffice'), 'officeId'), ((select id from stretchy_report where report_name='Loan Third Overdue Repayment Reminder'), (select id from stretchy_parameter where parameter_name = 'fromXSelect'), 'fromX'), ((select id from stretchy_report where report_name='Loan Third Overdue Repayment Reminder'), (select id from stretchy_parameter where parameter_name = 'toYSelect'), 'toY');
INSERT IGNORE INTO `stretchy_report_parameter` (`report_id`, `parameter_id`, `report_parameter_name`) VALUES ((select id from stretchy_report where report_name='Loan Fourth Overdue Repayment Reminder'), (select id from stretchy_parameter where parameter_name = 'DefaultOffice'), 'officeId'), ((select id from stretchy_report where report_name='Loan Fourth Overdue Repayment Reminder'), (select id from stretchy_parameter where parameter_name = 'fromXSelect'), 'fromX'), ((select id from stretchy_report where report_name='Loan Fourth Overdue Repayment Reminder'), (select id from stretchy_parameter where parameter_name = 'toYSelect'), 'toY');
INSERT IGNORE INTO `stretchy_report_parameter` (`report_id`, `parameter_id`, `report_parameter_name`) VALUES ((select id from stretchy_report where report_name='DefaultWarning -  guarantors'), (select id from stretchy_parameter where parameter_name = 'DefaultOffice'), 'officeId'), ((select id from stretchy_report where report_name='DefaultWarning -  guarantors'), (select id from stretchy_parameter where parameter_name = 'fromXSelect'), 'fromX'), ((select id from stretchy_report where report_name='DefaultWarning -  guarantors'), (select id from stretchy_parameter where parameter_name = 'toYSelect'), 'toY');
INSERT IGNORE INTO `stretchy_report_parameter` (`report_id`, `parameter_id`, `report_parameter_name`) VALUES ((select id from stretchy_report where report_name='DefaultWarning - Clients'), (select id from stretchy_parameter where parameter_name = 'DefaultOffice'), 'officeId'), ((select id from stretchy_report where report_name='DefaultWarning - Clients'), (select id from stretchy_parameter where parameter_name = 'fromXSelect'), 'fromX'), ((select id from stretchy_report where report_name='DefaultWarning - Clients'), (select id from stretchy_parameter where parameter_name = 'toYSelect'), 'toY');

INSERT INTO `sms_campaign` (`campaign_name`, `campaign_type`, `campaign_trigger_type`, `report_id`, `provider_id`, `param_value`, `status_enum`, `message`, `closedon_date`, `closedon_userid`, `submittedon_date`, `submittedon_userid`, `approvedon_date`, `approvedon_userid`, `recurrence`, `next_trigger_date`, `last_trigger_date`, `recurrence_start_date`, `is_visible`) VALUES 
('Loan Repayment Reminders', 1, 2, (select id from stretchy_report where report_name='Loan Repayment Reminders'), 2, '{"startDate":"2017-11-10", "fromX":"1", "toY":"5", "officeId":"0", "reportName":"Loan Repayment Reminders"}', 300, 'Dear  {{client_name}}, your loan repayment is due on  {{due_date}}. Please pay to avoid arrears. {{branch_name}}', NULL, NULL, '2017-11-10', 1, '2017-11-10', 1, 'FREQ=DAILY', '2017-11-11 01:10:10', NULL, '2017-11-10 01:10:10', 1),
('Loan First Overdue Repayment Reminder', 1, 2, (select id from stretchy_report where report_name='Loan First Overdue Repayment Reminder'), 2, '{"startDate":"2017-11-10", "fromX":"1", "toY":"5", "officeId":"0", "reportName":"Loan First Overdue Repayment Reminder"}', 300, 'Dear {{client_name}}, your loan is overdue by {{overdue_amount}} for {{month}}, please repay your loan. {{branch_name}}.', NULL, NULL, '2017-11-10', 1, '2017-11-10', 1, 'FREQ=DAILY', '2017-11-11 01:10:10', NULL, '2017-11-10 01:10:10', 1),
('Loan Second Overdue Repayment Reminder', 1, 2, (select id from stretchy_report where report_name='Loan Second Overdue Repayment Reminder'), 2, '{"startDate":"2017-11-10", "fromX":"1", "toY":"5", "officeId":"0", "reportName":"Loan Second Overdue Repayment Reminder"}', 300, 'Dear {{client_name}}, your loan is overdue by {{overdue_amount}} for {{month}}, please repay your loan. {{branch_name}}.', NULL, NULL, '2017-11-10', 1, '2017-11-10', 1, 'FREQ=DAILY', '2017-11-11 01:10:10', NULL, '2017-11-10 01:10:10', 1),
('Loan Third Overdue Repayment Reminder', 1, 2, (select id from stretchy_report where report_name='Loan Third Overdue Repayment Reminder'), 2, '{"startDate":"2017-11-10", "fromX":"1", "toY":"5", "officeId":"0", "reportName":"Loan Third Overdue Repayment Reminder"}', 300, 'Dear {{Guarantor_name}}, loan for {{client_name}} where you are a guarantor is not being serviced.If the loan is not repaid,we will have to recover the balance from your committed shares. {{Client_Branch}}.', NULL, NULL, '2017-11-10', 1, '2017-11-10', 1, 'FREQ=DAILY', '2017-11-11 01:10:10', NULL, '2017-11-10 01:10:10', 1),
('Loan Fourth Overdue Repayment Reminder', 1, 2, (select id from stretchy_report where report_name='Loan Fourth Overdue Repayment Reminder'), 2, '{"startDate":"2017-11-10", "fromX":"1", "toY":"5", "officeId":"0", "reportName":"Loan Fourth Overdue Repayment Reminder"}', 300, 'Dear {{Guarantor_name}}, loan for {{client_name}} where you are a guarantor is not being serviced.If the loan is not repaid,we will have to recover the balance from your committed shares. {{Client_Branch}}.', NULL, NULL, '2017-11-10', 1, '2017-11-10', 1, 'FREQ=DAILY', '2017-11-11 01:10:10', NULL, '2017-11-10 01:10:10', 1),
('DefaultWarning guarantors', 1, 2, (select id from stretchy_report where report_name='DefaultWarning -  guarantors'), 2, '{"startDate":"2017-11-10", "fromX":"1", "toY":"5", "officeId":"0", "reportName":"DefaultWarning -  guarantors"}', 300, 'Dear {{Guarantor_name}}, loan for {{client_name}} is in default. Your committed shares to this loan {{comitted_Shares}} will be deducted from your shares to recover the loan balance. {{Guarantor_Branch}}.', NULL, NULL, '2017-11-10', 1, '2017-11-10', 1, 'FREQ=DAILY', '2017-11-11 01:10:10', NULL, '2017-11-10 01:10:10', 1),
('DefaultWarning Clients', 1, 2, (select id from stretchy_report where report_name='DefaultWarning - Clients'), 2, '{"startDate":"2017-11-10", "fromX":"1", "toY":"5", "officeId":"0", "reportName":"DefaultWarning - Clients"}', 300, 'Dear {{client_name}}, Your Loan is in default . The Loan Balance of {{overdue_amount}} will be recover from your committed shares. {{branch_name}} .', NULL, NULL, '2017-11-10', 1, '2017-11-10', 1, 'FREQ=DAILY', '2017-11-11 01:10:10', NULL, '2017-11-10 01:10:10', 1),
('DormancyWarning Clients', 1, 2, (select id from stretchy_report where report_name='DormancyWarning - Clients'), 2, '{"startDate":"2017-11-10", "officeId":"0", "reportName":"DormancyWarning - Clients"}', 300, 'Dear {{display_name}}, Your account will be moved to dormancy.Please make a payment to avoid this. {{branch_name}}.', NULL, NULL, '2017-11-10', 1, '2017-11-10', 1, 'FREQ=DAILY', '2017-11-11 01:10:10', NULL, '2017-11-10 01:10:10', 1);


SET FOREIGN_KEY_CHECKS=0;
INSERT INTO `sms_messages_outbound` (`client_id`, `status_enum`, `mobile_no`, `message`, `submittedon_date`, `external_id`, `campaign_id`, `delivered_on_date`)
SELECT IF(REPLACE(SUBSTRING_INDEX(d.entity_description,' ',1),'clientId:','')*1=0, NULL, REPLACE(SUBSTRING_INDEX(d.entity_description,' ',1),'clientId:','')*1) AS client_id
, IF(d.processed=1,300, 400) AS status_enum
, d.entity_mobile_no AS mobile_no
, IFNULL(d.message, ' ') AS message
, DATE(d.created_on) AS submittedon_date
, d.id AS external_id
, s.id as campaignId
, d.last_modified_on AS delivered_on_date
FROM event_sourcing_details d
left join stretchy_report r on r.report_name = d.report_name
left join sms_campaign s on s.report_id = r.id;
SET FOREIGN_KEY_CHECKS=1;

UPDATE `stretchy_report` SET `report_type`='SMS', `report_subtype`='NonTriggered', `report_category`='Loan'
WHERE `report_name` IN ('Loan Repayment Reminders', 'Loan First Overdue Repayment Reminder', 'Loan Second Overdue Repayment Reminder', 'Loan Third Overdue Repayment Reminder', 'Loan Fourth Overdue Repayment Reminder', 'DefaultWarning -  guarantors', 'DefaultWarning - Clients');

UPDATE `stretchy_report` SET `report_type`='SMS', `report_subtype`='NonTriggered', `report_category`='Savings'
WHERE `report_name` IN ('DormancyWarning - Clients');

UPDATE `stretchy_report` SET report_sql = 'select a.display_name,a.branch_name,a.last_transaction_date,\n       ifnull(a.mobile_no, \'NA\') as mobileNo,\n		 a.savings_Id,a.client_Id as id,a.product_Short_Name \nfrom\n(select cl.display_name,sa.product_id,cl.id as client_Id ,\n        cl.default_savings_product,sa.id as savings_Id,\n		  mo.name as branch_name,mp.short_name as product_Short_Name,\n        cl.mobile_no as mobile_no,\n        MAX(transaction_date)as last_transaction_date \nfrom m_client cl \ninner join m_office mo on mo.id=cl.office_id\ninner join OfficeDetails od on od.office_id=mo.id\ninner join m_savings_account sa on sa.client_id=cl.id \ninner join m_savings_product mp on mp.id=sa.product_id\nleft join m_savings_account_transaction msa on msa.savings_account_id=sa.id\nwhere  sa.id=cl.default_savings_account\nand (msa.transaction_type_enum=1 or msa.transaction_type_enum is null)\nand \ncl.status_enum = 300 and\ncl.sub_status =27 \nand sa.status_enum=300\nand od.sms_enabled=true\nand case when ${officeId} =0 then\n         1=1\n         else \n         mo.id = ${officeId}\n         end\ngroup by sa.account_no)a\nwhere \nif(a.last_transaction_date is null, TIMESTAMPDIFF (MONTH,curDate(),\'${startDate}\')=0,\n TIMESTAMPDIFF (MONTH,a.last_transaction_date,\'${startDate}\')=4)' WHERE `report_name` = 'DormancyWarning - Clients';
UPDATE `stretchy_report` SET report_sql = 'select a.client_name,a.branch_name,a.overdue_amount,a.mobile_no as mobileNo,\n       a.loan_id,a.client_id as id,a.productshort_Name\nfrom\n    (    select c.firstname as client_name,o.name as branch_name, c.mobile_no as mobile_no,\n	             date_format(lrc.duedate,\'%M \')as month,\n                c.id as client_id,l.id as loan_id,\n					 mp.short_name as productshort_Name,\n					 lrc.duedate as duedate, \n					 max(mlt.transaction_date) as last_txn_date,\n                ifnull(mlaa.total_overdue_derived,0) as overdue_amount,\n              if (((lrc.principal_amount+lrc.interest_amount)>(ifnull(lrc.principal_completed_derived,0)\n				       +ifnull(lrc.interest_completed_derived,0))),\n						 (datediff(\'${startDate}\',date_add(date_add(makedate(extract(year from lrc.duedate),\n						 extract(day from lrc.duedate)),interval extract(month from lrc.duedate) +3 month),\n						 interval 5 day))),null) as days,\n						 \n				   ifnull(sum(mlaa.total_overdue_derived),0) overdueAmount		   \n						  \n			     from m_client c \n				  inner join m_loan l on c.id=l.client_id\n				  inner join m_loan_transaction mlt on mlt.loan_id = l.id\n				  and mlt.is_reversed = 0\n				  inner join m_product_loan mp on mp.id=l.product_id \n			     inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id\n			     inner join m_office o on c.office_id=o.id\n			     inner join OfficeDetails od on od.office_id=o.id and od.sms_enabled=true\n			     join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id\n			     join event_sourcing_details esd on esd.report_name = \'DefaultWarning - Clients\'\n				  and esd.entity_mobile_no != c.mobile_no\n			     where datediff(\'${startDate}\',lrc.duedate)>=1       \n			     and  lrc.completed_derived=0\n			     and l.loan_status_id=300\n			     and case when ${officeId} =0 then\n		         1=1\n		         else \n		         o.id = ${officeId}\n		        end\n		        and case when ( select \n					count(esd.mobile_no)\n					from sms_messages_outbound esd\n					JOIN sms_campaign cam on cam.id = esd.campaign_id\n					JOIN stretchy_report rp on rp.id = cam.report_id\n					where (esd.status_enum = 200 OR esd.status_enum =300)\n					and rp.report_name = \'DefaultWarning - Clients\'\n					and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n			 \n				) >0 then\n		\n				c.mobile_no not in (\n					select esd.mobile_no\n					from sms_messages_outbound esd\n					JOIN sms_campaign cam on cam.id = esd.campaign_id\n					JOIN stretchy_report rp on rp.id = cam.report_id\n					where (esd.status_enum = 200 OR esd.status_enum =300)\n					and rp.report_name = \'DefaultWarning - Clients\'\n					and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n					group by esd.mobile_no\n				)\n				else\n				1\n			   end		        \n				  group by lrc.loan_id\n				  \n				  \n				  UNION \n				  \n				  \n				  \n				  select c.firstname as client_name,o.name as branch_name, c.mobile_no as mobile_no,\n	             date_format(lrc.duedate,\'%M \')as month,\n                c.id as client_id,l.id as loan_id,\n					 mp.short_name as productshort_Name,\n					 lrc.duedate as duedate, \n					 \'No_Date\' as last_txn_date,\n                ifnull(mlaa.total_overdue_derived,0) as overdue_amount,\n              if (((lrc.principal_amount+lrc.interest_amount)>(ifnull(lrc.principal_completed_derived,0)\n				       +ifnull(lrc.interest_completed_derived,0))),\n						 (datediff(\'${startDate}\',date_add(date_add(makedate(extract(year from lrc.duedate),\n						 extract(day from lrc.duedate)),interval extract(month from lrc.duedate) +3 month),\n						 interval 5 day))),null) as days,\n						 \n						 ifnull(sum(mlaa.total_overdue_derived),0) overdueAmount  \n						  \n			     from m_client c \n				  inner join m_loan l on c.id=l.client_id\n				  inner join m_loan_transaction mlt on mlt.loan_id = l.id \n				  and mlt.is_reversed = 0\n				  inner join m_product_loan mp on mp.id=l.product_id \n			     inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id\n			     inner join m_office o on c.office_id=o.id\n			     inner join OfficeDetails od on od.office_id=o.id and od.sms_enabled=true\n			     join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id\n			     where\n			       l.loan_status_id=300\n			     and \n			     \n			     case when ${officeId} =0 then\n		         1=1\n		         else \n		         o.id = ${officeId}\n		        end\n		        \n		   and \n			case when (  select \n					count(esd.mobile_no)\n					from sms_messages_outbound esd\n					JOIN sms_campaign cam on cam.id = esd.campaign_id\n					JOIN stretchy_report rp on rp.id = cam.report_id\n					where (esd.status_enum = 400)\n					and rp.report_name = \'DefaultWarning - Clients\'\n					and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n	     \n		            ) >0 then\n		\n		    c.mobile_no in (\n						select esd.mobile_no\n						from sms_messages_outbound esd\n						JOIN sms_campaign cam on cam.id = esd.campaign_id\n						JOIN stretchy_report rp on rp.id = cam.report_id\n						where (esd.status_enum = 400)\n						and rp.report_name = \'DefaultWarning - Clients\'\n						and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n						group by esd.mobile_no\n		   					)\n					 else\n						0\n					  end\n		        \n				  group by lrc.loan_id\n				  \n				  \n				  \n				  \n	  )a\n	  where a.overdue_amount > 0\n     and datediff(\'${startDate}\',a.last_txn_date) >= 150 OR a.last_txn_date = \'No_Date\'' WHERE `report_name` = 'DefaultWarning - Clients';
UPDATE `stretchy_report` SET report_sql = 'select \n       a.client_name,\n       a.Guarantor_name,\n		 a.Guarantor_Branch,\n		 a.client_mobile_no,\n		 a.loan_id,a.client_id as id,\n		 productshort_Name,\n		 a.Guarantor_mobile_no as mobileNo,\n		 a.comitted_Shares\nfrom\n		(select cl.firstname as client_name\n				,ifnull(go.firstname,concat(gu.firstname,gu.lastname)) as Guarantor_name\n				,ifnull(o.name,\'NA \') as Guarantor_Branch\n				,ifnull(go.mobile_no,gu.mobile_number) as Guarantor_mobile_no\n				,co.name as Client_Branch\n				,ifnull(cl.mobile_no,\'NA \') as client_mobile_no\n				,\n				cl.id as client_id,l.id as loan_id,mp.short_name as productshort_Name,\n				ifnull(gfd.amount_remaining_derived,0) as comitted_Shares, \n					max(mlt.transaction_date) as last_txn_date,\n					ifnull(sum(mlaa.total_overdue_derived),0) as overdueAmount \n					   \n					from m_loan l\n					inner join m_loan_transaction mlt on mlt.loan_id = l.id and mlt.is_reversed = 0\n					inner join m_product_loan mp on mp.id=l.product_id \n					inner join m_client cl on cl.id=l.client_id \n					inner join m_guarantor gu on gu.loan_id=l.id\n					left join m_guarantor_funding_details gfd on gfd.guarantor_id=gu.id\n					left join m_client go on go.id=gu.entity_id\n				   join m_savings_account msa on go.id = msa.client_id and msa.client_id != l.client_id\n					left join m_office o on o.id=go.office_id\n					left join m_office co on co.id=cl.office_id\n					inner join OfficeDetails od on od.office_id=co.id\n					join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id\n					join event_sourcing_details esd on esd.report_name = \'DefaultWarning -  guarantors\'\n				   and esd.entity_mobile_no != go.mobile_no\n				   and esd.entity_mobile_no != cl.mobile_no\n					where \n					l.loan_status_id=300\n					and   gu.is_active=1\n					and gfd.status_enum = 100\n					and od.sms_enabled=true\n					and case when ${officeId} =0 then\n			         1=1\n			         else \n			         o.id = ${officeId}\n			      end\n			      \n					group by l.id, gu.id\n					\n					\n					UNION \n					\n					\n				 select cl.firstname as client_name\n				,ifnull(go.firstname,concat(gu.firstname,gu.lastname)) as Guarantor_name\n				,ifnull(o.name,\'NA \') as Guarantor_Branch\n				,ifnull(go.mobile_no,gu.mobile_number) as Guarantor_mobile_no\n				,co.name as Client_Branch\n				,ifnull(cl.mobile_no,\'NA \') as client_mobile_no\n				,cl.id as client_id,l.id as loan_id,mp.short_name as productshort_Name,\n				ifnull(gfd.amount_remaining_derived,0) as comitted_Shares,  \n				\'No_Date\' as last_txn_date,\n				 ifnull(sum(mlaa.total_overdue_derived),0) as overdueAmount\n					   \n					from m_loan l\n					inner join m_loan_transaction mlt on mlt.loan_id = l.id and mlt.is_reversed = 0\n					inner join m_product_loan mp on mp.id=l.product_id \n					inner join m_client cl on cl.id=l.client_id \n					inner join m_guarantor gu on gu.loan_id=l.id\n					left join m_guarantor_funding_details gfd on gfd.guarantor_id=gu.id\n					left join m_client go on go.id=gu.entity_id\n				   join m_savings_account msa on go.id = msa.client_id and msa.client_id != l.client_id\n					left join m_office o on o.id=go.office_id\n					left join m_office co on co.id=cl.office_id\n					inner join OfficeDetails od on od.office_id=co.id\n					join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id\n					\n					where l.loan_status_id=300\n					and   gu.is_active=1\n					and gfd.status_enum = 100\n					and od.sms_enabled=true\n					and case when ${officeId} =0 then\n			         1=1\n			         else \n			         o.id = ${officeId}\n			      end\n			      \n			      and \n			case when (select \n					count(esd.mobile_no)\n					from sms_messages_outbound esd\n					JOIN sms_campaign cam on cam.id = esd.campaign_id\n					JOIN stretchy_report rp on rp.id = cam.report_id\n					where (esd.status_enum = 400)\n					and rp.report_name = \'DefaultWarning -  guarantors\'\n					and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n	     \n		            ) >0 then\n		\n		    ifnull(go.mobile_no,gu.mobile_number) in (\n						select esd.mobile_no\n						from sms_messages_outbound esd\n						JOIN sms_campaign cam on cam.id = esd.campaign_id\n						JOIN stretchy_report rp on rp.id = cam.report_id\n						where (esd.status_enum = 400)\n						and rp.report_name = \'DefaultWarning -  guarantors\'\n						and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n						group by esd.mobile_no\n					)\n					 else\n						0\n					  end\n			      \n					group by l.id, gu.id\n					\n					\n		 )a\n	  \n	where a.overdueAmount > 0\n	and\n	datediff(\'${startDate}\',a.last_txn_date) >= 150 or a.last_txn_date = \'No_Date\'' WHERE `report_name` = 'DefaultWarning -  guarantors';
UPDATE `stretchy_report` SET report_sql = 'select a .client_name,a.Guarantor_name,\na.Guarantor_Branch,a.client_mobile_no,a.loan_id,\na.client_id as id,a.productshort_Name,a.Guarantor_mobile_no as mobileNo \nfrom\n(\n select date_format(lrc.duedate,\'%M-%Y\')as month_year,\n  max(mlt.transaction_date) as last_txn_date,\n  cl.firstname as client_name\n ,ifnull(go.firstname,concat(gu.firstname,\'\',gu.lastname)) as Guarantor_name\n ,ifnull(o.name,\'NA \') as Guarantor_Branch\n ,ifnull(go.mobile_no,gu.mobile_number) as Guarantor_mobile_no\n ,co.name as Client_Branch\n ,ifnull(cl.mobile_no,\'NA \') as client_mobile_no\n ,min(lrc.duedate)as mindate\n ,lrc.duedate as duedate,\n cl.id as client_id,l.id as loan_id,mp.short_name as productshort_Name,\n if (((lrc.principal_amount+lrc.interest_amount)>(ifnull(lrc.principal_completed_derived,0)\n  +ifnull(lrc.interest_completed_derived,0))),\n  (datediff(\'${startDate}\',date_add(date_add(makedate(extract(year from lrc.duedate),extract(day from lrc.duedate))\n  ,interval extract(month from lrc.duedate) +2 month),interval 5 day))),null) as days,\n  ifnull(sum(mlaa.total_overdue_derived),0) as overdueAmount  \n  \n from m_loan l\n inner join m_loan_transaction mlt on l.id = mlt.loan_id and mlt.is_reversed = 0\n inner join m_product_loan mp on mp.id=l.product_id\n inner join m_client cl on cl.id=l.client_id \n inner join m_guarantor gu on gu.loan_id=l.id\n inner join m_guarantor_funding_details gf on gu.id = gf.guarantor_id\n inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id\n left join m_client go on go.id=gu.entity_id\n left join m_office o on o.id=go.office_id\n left join m_office co on co.id=cl.office_id\n inner join OfficeDetails od on od.office_id=co.id\n join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id\n where lrc.completed_derived=0\n and  gf.status_enum = 100\n and l.loan_status_id=300\n and od.sms_enabled=true\n and case when ${officeId} =0 then\n         1=1\n         else \n         o.id = ${officeId}\n         end\n         \n and case when (select \n				count(esd.mobile_no)\n				from sms_messages_outbound esd\n				JOIN sms_campaign cam on cam.id = esd.campaign_id\n				JOIN stretchy_report rp on rp.id = cam.report_id\n				where (esd.status_enum = 200 OR esd.status_enum =300)\n				and rp.report_name = \'Loan Fourth Overdue Repayment Reminder\'\n				and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n		         ) >0 then\n		\n		 go.mobile_no not in (\n						select esd.mobile_no\n						from sms_messages_outbound esd\n						JOIN sms_campaign cam on cam.id = esd.campaign_id\n						JOIN stretchy_report rp on rp.id = cam.report_id\n						where (esd.status_enum = 200 OR esd.status_enum =300)\n						and rp.report_name = \'Loan Fourth Overdue Repayment Reminder\'\n						and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n						group by esd.mobile_no\n		   		)\n				  else\n					1\n				  end        \n         \n group by gu.id\n \n \n UNION \n \n \n select date_format(lrc.duedate,\'%M-%Y\')as month_year,\n  \'No_Date\' as last_txn_date,\n  cl.firstname as client_name\n ,ifnull(go.firstname,concat(gu.firstname,\'\',gu.lastname)) as Guarantor_name\n ,ifnull(o.name,\'NA \') as Guarantor_Branch\n ,ifnull(go.mobile_no,gu.mobile_number) as Guarantor_mobile_no\n ,co.name as Client_Branch\n ,ifnull(cl.mobile_no,\'NA \') as client_mobile_no\n ,min(lrc.duedate)as mindate\n ,lrc.duedate as duedate,\n cl.id as client_id,l.id as loan_id,mp.short_name as productshort_Name,\n if (((lrc.principal_amount+lrc.interest_amount)>(ifnull(lrc.principal_completed_derived,0)\n  +ifnull(lrc.interest_completed_derived,0))),\n  (datediff(\'${startDate}\',date_add(date_add(makedate(extract(year from lrc.duedate),extract(day from lrc.duedate))\n  ,interval extract(month from lrc.duedate) +2 month),interval 5 day))),null) as days,\n  \n  ifnull(sum(mlaa.total_overdue_derived),0) as overdueAmount  \n  \n from m_loan l\n inner join m_loan_transaction mlt on l.id = mlt.loan_id and mlt.is_reversed = 0\n inner join m_product_loan mp on mp.id=l.product_id\n inner join m_client cl on cl.id=l.client_id \n inner join m_guarantor gu on gu.loan_id=l.id\n inner join m_guarantor_funding_details gf on gu.id = gf.guarantor_id\n inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id\n left join m_client go on go.id=gu.entity_id\n left join m_office o on o.id=go.office_id\n left join m_office co on co.id=cl.office_id\n inner join OfficeDetails od on od.office_id=co.id  and od.sms_enabled=true\n join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id\n where gf.status_enum = 100\n and l.loan_status_id=300\n\n and case when ${officeId} =0 then\n         1=1\n         else \n         o.id = ${officeId}\n         end\n         \n and case when (    select \n					count(esd.mobile_no)\n					from sms_messages_outbound esd\n					JOIN sms_campaign cam on cam.id = esd.campaign_id\n					JOIN stretchy_report rp on rp.id = cam.report_id\n					where (esd.status_enum = 400)\n					and rp.report_name = \'Loan Fourth Overdue Repayment Reminder\'\n					and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n		         ) >0 then\n		\n		 go.mobile_no in (\n					select esd.mobile_no\n					from sms_messages_outbound esd\n					JOIN sms_campaign cam on cam.id = esd.campaign_id\n					JOIN stretchy_report rp on rp.id = cam.report_id\n					where (esd.status_enum = 400)\n					and rp.report_name = \'Loan Fourth Overdue Repayment Reminder\'\n					and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n					group by esd.mobile_no\n		   		)\n				  else\n					0\n				  end\n        \n group by gu.id\n \n)a\n\nwhere a.overdueAmount > 0\nand\ndatediff(\'${startDate}\',a.last_txn_date) = 150 or a.last_txn_date = \'No_Date\'' WHERE `report_name` = 'Loan Fourth Overdue Repayment Reminder';
UPDATE `stretchy_report` SET report_sql = 'select a.client_name,a.Guarantor_name,a.Guarantor_Branch,\n       a.client_mobile_no,a.loan_id,a.client_id as id,productshort_Name,\n		 a.Guarantor_mobile_no as mobileNo\nfrom\n(\n\nselect \n max(mlt.transaction_date) as last_txn_date\n,cl.firstname as client_name\n,ifnull(go.firstname,concat(gu.firstname,\'\',gu.lastname)) as Guarantor_name\n,ifnull(o.name,\'NA \') as Guarantor_Branch\n,ifnull(go.mobile_no,gu.mobile_number) as Guarantor_mobile_no\n,co.name as Client_Branch\n,ifnull(cl.mobile_no,\'NA\') as client_mobile_no\n,cl.id as client_id,l.id as loan_id,mp.short_name as productshort_Name,\nifnull(sum(mlaa.total_overdue_derived),0) overdueAmount	\n		  \nfrom m_loan l\ninner join m_loan_transaction mlt on l.id = mlt.loan_id and mlt.is_reversed = 0\ninner join m_product_loan mp on mp.id=l.product_id \ninner join m_client cl on cl.id=l.client_id \ninner join m_guarantor gu on gu.loan_id=l.id\ninner join m_guarantor_funding_details gf on gu.id = gf.guarantor_id\nleft join m_client go on go.id=gu.entity_id\nleft join m_office o on o.id=go.office_id\nleft join m_office co on co.id=cl.office_id\ninner join OfficeDetails od on od.office_id=co.id\nleft join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id\nwhere l.loan_status_id=300\nand od.sms_enabled=true\nand gf.status_enum = 100\nand case when ${officeId} =0 then\n         1=1\n         else \n         o.id = ${officeId}\n         end\n         \nand case when ( select \n				count(esd.mobile_no)\n				from sms_messages_outbound esd\n				JOIN sms_campaign cam on cam.id = esd.campaign_id\n				JOIN stretchy_report rp on rp.id = cam.report_id\n				where (esd.status_enum = 200 OR esd.status_enum =300)\n				and rp.report_name = \'Loan Third Overdue Repayment Reminder\'\n				and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n	     \n		   	) >0 then\n		\n		 	go.mobile_no not in (\n								select esd.mobile_no\n								from sms_messages_outbound esd\n								JOIN sms_campaign cam on cam.id = esd.campaign_id\n								JOIN stretchy_report rp on rp.id = cam.report_id\n								where (esd.status_enum = 200 OR esd.status_enum =300)\n								and rp.report_name = \'Loan Third Overdue Repayment Reminder\'\n								and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n								group by esd.mobile_no\n		   					)\n				else\n				1\n			   end\n      \n                   \n         \ngroup by gu.id\n\n\n  UNION \n  \nselect \n \'No_Date\' as last_txn_date\n,cl.firstname as client_name\n,ifnull(go.firstname,concat(gu.firstname,\'\',gu.lastname)) as Guarantor_name\n,ifnull(o.name,\'NA \') as Guarantor_Branch\n,ifnull(go.mobile_no,gu.mobile_number) as Guarantor_mobile_no\n,co.name as Client_Branch\n,ifnull(cl.mobile_no,\'NA\') as client_mobile_no\n,cl.id as client_id,l.id as loan_id,mp.short_name as productshort_Name, \nifnull(sum(mlaa.total_overdue_derived),0) overdueAmount		  \nfrom m_loan l\ninner join m_loan_transaction mlt on l.id = mlt.loan_id and mlt.is_reversed = 0\ninner join m_product_loan mp on mp.id=l.product_id \ninner join m_client cl on cl.id=l.client_id \ninner join m_guarantor gu on gu.loan_id=l.id and gu.is_active = true\ninner join m_guarantor_funding_details gf on gu.id = gf.guarantor_id and gf.status_enum = 100\nleft join m_client go on go.id=gu.entity_id\nleft join m_office o on o.id=go.office_id\nleft join m_office co on co.id=cl.office_id\ninner join OfficeDetails od on od.office_id=co.id and od.sms_enabled=true\nleft join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id\nwhere  \n case when ${officeId} =0 then\n         1=1\n         else \n         o.id = ${officeId}\n         end\n         \n         \n  and case when (   select \n					count(esd.mobile_no)\n					from sms_messages_outbound esd\n					JOIN sms_campaign cam on cam.id = esd.campaign_id\n					JOIN stretchy_report rp on rp.id = cam.report_id\n					where (esd.status_enum = 400)\n					and rp.report_name = \'Loan Third Overdue Repayment Reminder\'\n					and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n	     \n		   		 ) >0 then\n		\n		 	go.mobile_no in (\n								select esd.mobile_no\n								from sms_messages_outbound esd\n								JOIN sms_campaign cam on cam.id = esd.campaign_id\n								JOIN stretchy_report rp on rp.id = cam.report_id\n								where (esd.status_enum = 400)\n								and rp.report_name = \'Loan Third Overdue Repayment Reminder\'\n								and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n								group by esd.mobile_no\n		   					)\n				else\n				0\n			   end\n      \n            group by gu.id\n\n\n )a\n  \nwhere  a.overdueAmount > 0\nand  datediff(\'${startDate}\',a.last_txn_date) = 120 or a.last_txn_date = \'No_Date\'' WHERE `report_name` = 'Loan Third Overdue Repayment Reminder';
UPDATE `stretchy_report` SET report_sql = 'select a.client_name,a.branch_name,a.overdue_amount,a.mobile_no as mobileNo,a.loan_id,a.client_id as id,\n       a.productshort_Name, a.month \n       \nfrom\n(\n   -- normal case: where the last loan repayment was before 60 days then should recived the \n   -- second reminder\n  select c.firstname as client_name,o.name as branch_name, c.mobile_no as mobile_no,\n        date_format(max(mlt.transaction_date),\'%M\') as month,\n        date_format(lrc.duedate,\'%M-%Y\')as month_year,\n        max(mlt.transaction_date) as last_txn_date,\n        c.id as client_id,l.id as loan_id,\n		  mp.short_name as productshort_Name,\n		  lrc.duedate as duedate, \n        round(ifnull(mlaa.total_overdue_derived,0),0) as overdue_amount,\n		      \n        if (((lrc.principal_amount+lrc.interest_amount)>(ifnull(lrc.principal_completed_derived,0)+\n		      ifnull(lrc.interest_completed_derived,0))),\n				(datediff(\'${startDate}\',\n				date_add(date_add(makedate(extract(year from lrc.duedate),extract(day from lrc.duedate)),\n				interval extract(month from lrc.duedate) month),interval 5 day))),null) as days  \n				\n  from m_client c \n     inner join m_loan l on c.id=l.client_id and l.loan_status_id=300\n     inner join m_loan_transaction mlt on l.id = mlt.loan_id and mlt.is_reversed = 0\n     inner join m_product_loan mp on mp.id=l.product_id \n     inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id\n     inner join m_office o on c.office_id=o.id\n     inner join OfficeDetails od on od.office_id=o.id and od .sms_enabled=true\n     left join m_loan_arrears_aging mlaa on l.id = mlaa.loan_id\n     where       \n     \n     case when ${officeId} =0 then\n         1=1\n         else \n         o.id = ${officeId}\n         end\n        \n	  and \n	\n	  case when (select \n						count(esd.mobile_no)\n						from sms_messages_outbound esd\n						JOIN sms_campaign cam on cam.id = esd.campaign_id\n						JOIN stretchy_report rp on rp.id = cam.report_id\n						where (esd.status_enum = 200 OR esd.status_enum =300)\n						and rp.report_name = \'Loan Second Overdue Repayment Reminder\'\n						and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n		   			) >0 then\n		\n					c.mobile_no not in (\n						select esd.mobile_no\n						from sms_messages_outbound esd\n						JOIN sms_campaign cam on cam.id = esd.campaign_id\n						JOIN stretchy_report rp on rp.id = cam.report_id\n						where (esd.status_enum = 200 OR esd.status_enum =300)\n						and rp.report_name = \'Loan Second Overdue Repayment Reminder\'\n						and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n						group by esd.mobile_no\n					)\n					else\n					1\n	 				end	   \n         \n        \n	  group by lrc.loan_id\n	  \n\n	  \n	  UNION \n	  \n     select c.firstname as client_name,o.name as branch_name, c.mobile_no as mobile_no,\n        date_format(max(mlt.transaction_date),\'%M-%Y\') as month,\n        date_format(lrc.duedate,\'%M\')as month_year,\n        \'No_Date\' as last_txn_date,\n        c.id as client_id,l.id as loan_id,\n		  mp.short_name as productshort_Name,\n		  lrc.duedate as duedate, \n        round(ifnull(mlaa.total_overdue_derived,0),0) as overdue_amount,\n		      \n        if (((lrc.principal_amount+lrc.interest_amount)>(ifnull(lrc.principal_completed_derived,0)+\n		      ifnull(lrc.interest_completed_derived,0))),\n				(datediff(\'${startDate}\',\n				date_add(date_add(makedate(extract(year from lrc.duedate),extract(day from lrc.duedate)),\n				interval extract(month from lrc.duedate) month),interval 5 day))),null) as days  \n				\n  from m_client c \n     inner join m_loan l on c.id=l.client_id and l.loan_status_id=300\n     inner join m_loan_transaction mlt on l.id = mlt.loan_id and mlt.is_reversed = 0\n     inner join m_product_loan mp on mp.id=l.product_id \n     inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id\n     inner join m_office o on c.office_id=o.id\n     inner join OfficeDetails od on od.office_id=o.id and od .sms_enabled=true\n     left join m_loan_arrears_aging mlaa on l.id = mlaa.loan_id\n     where       \n     \n     case when ${officeId} =0 then\n         1=1\n         else \n         o.id = ${officeId}\n         end\n      and \n      case when (   select \n					count(esd.mobile_no)\n					from sms_messages_outbound esd\n					JOIN sms_campaign cam on cam.id = esd.campaign_id\n					JOIN stretchy_report rp on rp.id = cam.report_id\n					where (esd.status_enum = 400)\n					and rp.report_name = \'Loan Second Overdue Repayment Reminder\'\n					and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n	   \n		          ) >0 then\n		\n		         c.mobile_no in (\n									select esd.mobile_no\n									from sms_messages_outbound esd\n									JOIN sms_campaign cam on cam.id = esd.campaign_id\n									JOIN stretchy_report rp on rp.id = cam.report_id\n									where (esd.status_enum = 400)\n									and rp.report_name = \'Loan Second Overdue Repayment Reminder\'\n									and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n									group by esd.mobile_no\n		                      )\n					else\n					0\n	 				end\n	     \n	  group by lrc.loan_id\n	  \n	  \n	  \n	  \n	  \n )a\n\n where  a.overdue_amount > 0 \n and \n datediff(\'${startDate}\',last_txn_date) = 90 or last_txn_date = \'No_Date\'\n group by a.mobile_no' WHERE `report_name` = 'Loan Second Overdue Repayment Reminder';
UPDATE `stretchy_report` SET report_sql = 'select  a.client_name,\n        a.branch_name,\n		a.overdue_amount,\n		a.mobile_no as mobileNo,\n		a.loan_id,\n		a.client_id as id,\n		a.productshort_Name,\n        a.month \nfrom\n    ( select c.firstname as client_name,\n	          o.name as branch_name, c.mobile_no as mobile_no,\n				 date_format(max(mlt.transaction_date),\'%M\') as month,\n				 max(mlt.transaction_date) as last_txn_date,\n             c.id as client_id,l.id as loan_id,\n				 mp.short_name as productshort_Name,\n             round(ifnull(mlaa.total_overdue_derived,0),0) as overdue_amount,\n            if (((lrc.principal_amount+lrc.interest_amount)>(ifnull(lrc.principal_completed_derived,0)\n				   +ifnull(lrc.interest_completed_derived,0))),\n					(datediff(\'${startDate}\',lrc.duedate)),null) as days \n \n     from m_client c\n	  inner join m_loan l on c.id=l.client_id and l.loan_status_id=300 \n	  inner join m_loan_transaction mlt on l.id = mlt.loan_id and mlt.is_reversed = 0\n     inner join m_product_loan mp on mp.id=l.product_id\n     inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id\n     inner join m_office o on c.office_id=o.id\n     inner join OfficeDetails od on od.office_id=o.id and od.sms_enabled=true\n     left join m_loan_arrears_aging mlaa on l.id = mlaa.loan_id\n   \n     where \n     \n     \n     case when ${officeId} =0 then\n         1=1\n         else \n         o.id = ${officeId}\n         end\n	  \n	  \n	  and case when (select \n						count(esd.mobile_no)\n						from sms_messages_outbound esd\n						JOIN sms_campaign cam on cam.id = esd.campaign_id\n						JOIN stretchy_report rp on rp.id = cam.report_id\n						where (esd.status_enum = 200 OR esd.status_enum =300)\n						and rp.report_name = \'Loan First Overdue Repayment Reminder\'\n						and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n		   			) >0 then\n		\n		 				c.mobile_no not in (\n							  select esd.mobile_no\n						        from sms_messages_outbound esd\n						        JOIN sms_campaign cam on cam.id = esd.campaign_id\n						        JOIN stretchy_report rp on rp.id = cam.report_id\n						        where (esd.status_enum = 200 OR esd.status_enum =300)\n						        and rp.report_name = \'Loan First Overdue Repayment Reminder\'\n						        and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n							group by esd.mobile_no\n		  				 )\n				else\n					1\n	  			end    \n         \n	  			group by lrc.loan_id\n	  \n	  \n	  \n	  UNION \n	  \n	  \n	  select c.firstname as client_name,\n	          o.name as branch_name, c.mobile_no as mobile_no,\n				 date_format(max(mlt.transaction_date),\'%M\')  as month,\n				 \'No_Date\' as last_txn_date,\n             c.id as client_id,l.id as loan_id,\n				 mp.short_name as productshort_Name,\n             round(ifnull(mlaa.total_overdue_derived,0),0) as overdue_amount,\n            if (((lrc.principal_amount+lrc.interest_amount)>(ifnull(lrc.principal_completed_derived,0)\n				   +ifnull(lrc.interest_completed_derived,0))),\n					(datediff(\'${startDate}\',lrc.duedate)),null) as days \n \n     from m_client c\n	  inner join m_loan l on c.id=l.client_id and l.loan_status_id=300 \n	  inner join m_loan_transaction mlt on l.id = mlt.loan_id and mlt.is_reversed = 0\n     inner join m_product_loan mp on mp.id=l.product_id\n     inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id\n     inner join m_office o on c.office_id=o.id\n     inner join OfficeDetails od on od.office_id=o.id  and od.sms_enabled=true\n     left join m_loan_arrears_aging mlaa on l.id = mlaa.loan_id\n    \n     where\n      case when ${officeId} =0 then\n         1=1\n         else \n         o.id = ${officeId}\n         end\n         \n     and case when (  select \n					        count(esd.mobile_no)\n						        from sms_messages_outbound esd\n						        JOIN sms_campaign cam on cam.id = esd.campaign_id\n						        JOIN stretchy_report rp on rp.id = cam.report_id\n						        where (esd.status_enum = 400)\n						        and rp.report_name = \'Loan First Overdue Repayment Reminder\'\n						        and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n	    \n		             ) > 0 \n						 \n						 then\n		\n		           c.mobile_no in (\n									select esd.mobile_no\n									from sms_messages_outbound esd\n									JOIN sms_campaign cam on cam.id = esd.campaign_id\n									JOIN stretchy_report rp on rp.id = cam.report_id\n									where (esd.status_enum = 400)\n									and rp.report_name = \'Loan First Overdue Repayment Reminder\'\n									and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n									group by esd.mobile_no\n		   							  )\n		       else\n	      	 0\n	          end\n   \n    \n    \n	  group by lrc.loan_id\n	  \n	  \n	  )a\n\nwhere  a.overdue_amount > 0\n AND datediff(\'${startDate}\',a.last_txn_date) = 30 or a.last_txn_date = \'No_Date\'' WHERE `report_name` = 'Loan First Overdue Repayment Reminder';
UPDATE `stretchy_report` SET report_sql = 'select a.client_name,a.branch_name,a.due_date,a.mobile_no as mobileNo,a.loan_id ,a.client_id as id, a.productshort_name \nfrom\n(select c.display_name as client_name,o.name as branch_name, lrc.duedate as due_date,c.mobile_no as mobile_no,\n l.id as loan_id,c.id as client_id,\n mp.short_name as productShort_name,\n if (((ifnull(lrc.principal_amount,0)+ ifnull(lrc.interest_amount,0))>\n     (ifnull(lrc.principal_completed_derived,0)+ifnull(lrc .interest_completed_derived,0))),\n	  (datediff(lrc.duedate,\'${startDate}\')),null) as days,\n	  max(mlt.transaction_date) as last_txn_date,\n	  ifnull(mlaa.total_overdue_derived,0) as arrears\n	   \n     from m_client c inner join m_loan l on c.id=l.client_id\n     inner join m_product_loan mp on mp.id=l.product_id\n     inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id   \n	  join m_loan_transaction mlt on mlt.loan_id = l.id and mlt.is_reversed = 0\n     inner join m_office o on c.office_id=o.id\n     inner join OfficeDetails od on od.office_id=o.id\n     left join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id\n     where  lrc.completed_derived=0\n     and l.loan_status_id=300\n     and od.sms_enabled=true\n     and case when ${officeId}=0 then\n         1=1\n         else \n         o.id = ${officeId}\n         end\n          \n          \n       and case when (    select \n                                count(esd.mobile_no)\n						        from sms_messages_outbound esd\n						        JOIN sms_campaign cam on cam.id = esd.campaign_id\n						        JOIN stretchy_report rp on rp.id = cam.report_id\n						        where (esd.status_enum = 200 OR esd.status_enum =300)\n						        and rp.report_name = \'Loan Repayment Reminders\'\n						        and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n	     \n		               ) >0 then\n		\n		 c.mobile_no not in (\n							select esd.mobile_no\n						        from sms_messages_outbound esd\n						        JOIN sms_campaign cam on cam.id = esd.campaign_id\n						        JOIN stretchy_report rp on rp.id = cam.report_id\n						        where (esd.status_enum = 200 OR esd.status_enum =300)\n						        and rp.report_name = \'Loan Repayment Reminders\'\n						        and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n							group by esd.mobile_no\n		   				)\n				else\n				1\n			  end    \n             \n          \n          \n	  group by l.id\n	  \n	  \n	  \n	  UNION \n	  \n	  \n	  select c.display_name as client_name,o.name as branch_name, lrc.duedate as due_date,c.mobile_no as mobile_no,\n l.id as loan_id,c.id as client_id,\n mp.short_name as productShort_name,\n if (((ifnull(lrc.principal_amount,0)+ ifnull(lrc.interest_amount,0))>\n     (ifnull(lrc.principal_completed_derived,0)+ifnull(lrc .interest_completed_derived,0))),\n	  (datediff(lrc.duedate,\'${startDate}\')),null) as days,\n	  max(mlt.transaction_date) as last_txn_date,\n	  ifnull(mlaa.total_overdue_derived,0) as arrears\n	   \n     from m_client c inner join m_loan l on c.id=l.client_id\n     inner join m_product_loan mp on mp.id=l.product_id\n     inner join m_loan_repayment_schedule lrc on lrc.loan_id=l.id   \n	  join m_loan_transaction mlt on mlt.loan_id = l.id and mlt.is_reversed = 0\n     inner join m_office o on c.office_id=o.id\n     inner join OfficeDetails od on od.office_id=o.id\n     left join m_loan_arrears_aging mlaa on mlaa.loan_id = l.id\n     where  lrc.completed_derived=0\n     and l.loan_status_id=300\n     and od.sms_enabled=true\n     and case when ${officeId}=0 then\n         1=1\n         else \n         o.id = ${officeId}\n         end\n      \n		and case when (  select \n					        count(esd.mobile_no)\n						        from sms_messages_outbound esd\n						        JOIN sms_campaign cam on cam.id = esd.campaign_id\n						        JOIN stretchy_report rp on rp.id = cam.report_id\n						        where (esd.status_enum = 400)\n						        and rp.report_name = \'Loan Repayment Reminders\'\n						        and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n	    \n		  					) >0 then\n		\n		 c.mobile_no in (\n							select esd.mobile_no\n						        from sms_messages_outbound esd\n						        JOIN sms_campaign cam on cam.id = esd.campaign_id\n						        JOIN stretchy_report rp on rp.id = cam.report_id\n						        where (esd.status_enum = 400)\n						        and rp.report_name = \'Loan Repayment Reminders\'\n						        and DATEDIFF(\'${startDate}\',esd.submittedon_date) between ${fromX} and ${toY}\n							group by esd.mobile_no\n		  					 )\n				else\n				0\n			  end    \n          \n          \n	  group by l.id\n	  \n	  \n	  \n	  \n	  \n  )a\n\n where\n case when extract(year_month from (a.last_txn_date)) = extract(year_month from (\'${startDate}\'))\n		    then\n	          a.arrears > 0\n	   else \n	    1\n end and a.days between ${fromX} and ${toY}\n \n       \n group by a.loan_id' WHERE `report_name` = 'Loan Repayment Reminders';

UPDATE `job` SET `is_active` = 0
WHERE name IN ('Loan Repayment Sms Reminder','Loan First Overdue Repayment Reminder','Loan Second Overdue Repayment Reminder','Loan Third Overdue Repayment Reminder','Loan Fourth Overdue Repayment Reminder','Default Wring Sms To Client','Default Warning Sms To gurantor','Dormancy Warning Sms To Clients');

ALTER TABLE `sms_messages_outbound`
	CHANGE COLUMN `external_id` `external_id` VARCHAR(100) NULL DEFAULT NULL AFTER `source_address`;

